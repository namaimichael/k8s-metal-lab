---
# =============================================================================
# worker â€” join the cluster
# =============================================================================

- name: Check if already joined
  stat:
    path: /etc/kubernetes/kubelet.conf
  register: kubelet_conf

- name: Join worker to cluster
  command: "{{ hostvars['k8s_join_holder']['k8s_join_command'] }}"
  when: not kubelet_conf.stat.exists

- name: Wait for worker node to be ready
  command: >
    kubectl get node {{ inventory_hostname }}
    --no-headers
    -o custom-columns=STATUS:.status.conditions[-1].type
  delegate_to: "{{ groups['control_plane'][0] }}"
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  register: node_status
  until: node_status.stdout == "Ready"
  retries: 20
  delay: 10
  changed_when: false
